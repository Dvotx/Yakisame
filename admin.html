<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Yakisame</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0F0F0F 0%, #1E1E1E 100%);
            color: white;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
        }

        .header h1 {
            color: #C9A961;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .header p {
            color: #E6D5A8;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .login-box, .admin-panel {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(201, 169, 97, 0.2);
        }

        .login-box {
            text-align: center;
        }

        .login-box h2 {
            color: #E6D5A8;
            margin-bottom: 15px;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .login-box p {
            color: #999;
            margin-bottom: 40px;
            font-size: 1rem;
            line-height: 1.6;
        }

        .btn-login-google {
            background: linear-gradient(135deg, #C9A961 0%, #E6D5A8 100%);
            color: #0F0F0F;
            border: none;
            padding: 16px 50px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            box-shadow: 0 8px 25px rgba(201, 169, 97, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-login-google:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(201, 169, 97, 0.5);
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #E6D5A8;
            font-weight: 600;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border-radius: 12px;
            border: 2px solid rgba(201, 169, 97, 0.3);
            background: rgba(15, 15, 15, 0.6);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #C9A961;
            background: rgba(15, 15, 15, 0.9);
            box-shadow: 0 0 0 4px rgba(201, 169, 97, 0.1);
        }

        .form-group select option {
            background: #1E1E1E;
            color: white;
        }

        .form-group small {
            display: block;
            margin-top: 8px;
            color: #777;
            font-size: 0.85rem;
        }

        .btn-submit {
            background: linear-gradient(135deg, #C9A961 0%, #E6D5A8 100%);
            color: #0F0F0F;
            border: none;
            padding: 16px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 8px 25px rgba(201, 169, 97, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(201, 169, 97, 0.5);
        }

        .btn-logout {
            background: transparent;
            border: 2px solid #C9A961;
            color: #C9A961;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-logout:hover {
            background: #C9A961;
            color: #0F0F0F;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding: 20px;
            background: rgba(201, 169, 97, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(201, 169, 97, 0.2);
        }

        .user-info strong {
            color: #E6D5A8;
        }

        .hidden {
            display: none;
        }

        .success-message {
            background: linear-gradient(135deg, rgba(201, 169, 97, 0.2) 0%, rgba(230, 213, 168, 0.2) 100%);
            border: 1px solid #C9A961;
            color: #E6D5A8;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
        }

        .admin-panel h2 {
            color: #C9A961;
            margin-bottom: 35px;
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .produtos-lista {
            margin-top: 50px;
        }

        .produto-item {
            background: rgba(15, 15, 15, 0.6);
            border: 1px solid rgba(201, 169, 97, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
        }

        .produto-item:hover {
            border-color: #C9A961;
            background: rgba(15, 15, 15, 0.8);
        }

        .produto-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .produto-item .emoji-display {
            font-size: 3rem;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(201, 169, 97, 0.1);
            border-radius: 8px;
        }

        .produto-info {
            flex: 1;
        }

        .produto-info h4 {
            color: #E6D5A8;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .produto-info small {
            color: #888;
            display: block;
        }

        .produto-acoes {
            display: flex;
            gap: 10px;
        }

        .btn-editar, .btn-excluir {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-editar {
            background: #4CAF50;
            color: white;
        }

        .btn-editar:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-excluir {
            background: #f44336;
            color: white;
        }

        .btn-excluir:hover {
            background: #da190b;
            transform: translateY(-2px);
        }

        .categoria-badge {
            display: inline-block;
            background: rgba(201, 169, 97, 0.2);
            color: #E6D5A8;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-left: 10px;
        }

        .loading {
            text-align: center;
            color: #888;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Painel Admin - Yakisame</h1>
            <p>Sistema de Gerenciamento de Produtos</p>
        </div>

        <!-- TELA DE LOGIN -->
        <div id="loginBox" class="login-box">
            <h2 style="margin-bottom: 20px;">Login Admin</h2>
            <p style="margin-bottom: 30px; color: #E6D5A8;">Entre com sua conta Google para gerenciar produtos</p>
            <button id="btnLoginGoogle" class="btn-login-google">
                Entrar com Google
            </button>
        </div>

        <!-- PAINEL ADMIN (escondido inicialmente) -->
        <div id="adminPanel" class="admin-panel hidden">
            <div class="user-info">
                <div>
                    <strong>Logado como:</strong> <span id="userName"></span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="btnLogout" class="btn-logout">üö™ Sair</button>
                </div>
            </div>

            <div id="successMessage" class="success-message hidden">
                Produto adicionado com sucesso!
            </div>

            <!-- Gerenciamento de Categorias -->
            <div class="categorias-section" style="margin-bottom: 50px; padding: 30px; background: rgba(201, 169, 97, 0.1); border-radius: 12px; border: 1px solid rgba(201, 169, 97, 0.3);">
                <h2 style="margin-bottom: 25px; color: #C9A961;">üìÇ Gerenciar Categorias</h2>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 15px; margin-bottom: 20px;">
                    <input type="text" id="novaCategoriaNome" placeholder="Nome da categoria (ex: Notebooks)" style="padding: 12px; border-radius: 8px; border: 2px solid rgba(201, 169, 97, 0.3); background: rgba(15, 15, 15, 0.6); color: white;">
                    <input type="number" id="novaCategoriaOrdem" placeholder="Ordem" value="1" min="1" style="padding: 12px; border-radius: 8px; border: 2px solid rgba(201, 169, 97, 0.3); background: rgba(15, 15, 15, 0.6); color: white;">
                    <button id="btnAdicionarCategoria" style="padding: 12px 30px; background: linear-gradient(135deg, #C9A961 0%, #E6D5A8 100%); color: #0F0F0F; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">‚ûï Adicionar</button>
                </div>
                
                <div id="listaCategoriasAdmin" style="display: grid; gap: 10px;"></div>
            </div>

            <h2 style="margin-bottom: 30px; color: #C9A961;" id="formTitle">Adicionar Novo Produto</h2>
            
            <form id="formProduct">
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="categoria" required>
                        <option value="">Selecione...</option>
                        <option value="notebooks">Notebooks</option>
                        <option value="celulares">Celulares</option>
                        <option value="tablets">Tablets</option>
                        <option value="monitores">Monitores</option>
                        <option value="teclados">Teclados</option>
                        <option value="mouses">Mouses</option>
                        <option value="headsets">Headsets</option>
                        <option value="webcams">Webcams</option>
                        <option value="acessorios">Acess√≥rios</option>
                        <option value="games">Games</option>
                        <option value="pc-gamer">PC Gamer</option>
                        <option value="cadeiras">Cadeiras Gamer</option>
                        <option value="smartwatches">Smartwatches</option>
                        <option value="fones">Fones de Ouvido</option>
                        <option value="caixas-som">Caixas de Som</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Nome do Produto</label>
                    <input type="text" id="nomeProduto" placeholder="Ex: Notebook Gamer Dell" required>
                </div>

                <div class="form-group">
                    <label>Link de Afiliado</label>
                    <input type="url" id="linkAfiliado" placeholder="https://..." required>
                    <small id="imagemStatus" style="color: #888; display: block; margin-top: 5px;">Cole o link e a imagem ser√° buscada automaticamente</small>
                    <div id="previewImagem" style="margin-top: 10px; display: none;">
                        <img id="imgPreview" style="max-width: 200px; border-radius: 8px; border: 2px solid #C9A961;" alt="Preview">
                    </div>
                </div>

                <div class="form-group">
                    <label>URL da Imagem (opcional)</label>
                    <input type="url" id="urlImagem" placeholder="Cole se a busca autom√°tica falhar">
                    <small style="color: #666; display: block; margin-top: 5px;">S√≥ preencha se a imagem n√£o for encontrada automaticamente</small>
                </div>

                <input type="hidden" id="produtoId" value="">
                <button type="submit" class="btn-submit" id="btnSubmit">Adicionar Produto</button>
                <button type="button" class="btn-logout" id="btnCancelar" style="display: none; margin-top: 15px; width: 100%;">Cancelar Edi√ß√£o</button>
            </form>

            <!-- Lista de Produtos -->
            <div class="produtos-lista">
                <h2 style="margin-bottom: 30px; color: #C9A961;">Produtos Cadastrados</h2>
                <div id="listaProdutos" class="loading">
                    Carregando produtos...
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, push, onValue, remove, update, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDE4rxt6EjDxHY510kwmg9dMCDBwZmAgCk",
            authDomain: "yakisame-b57b6.firebaseapp.com",
            projectId: "yakisame-b57b6",
            storageBucket: "yakisame-b57b6.firebasestorage.app",
            messagingSenderId: "421411319772",
            appId: "1:421411319772:web:0ba4d2ecaaa0aad69da919",
            measurementId: "G-YRKQ7S006F",
            databaseURL: "https://yakisame-b57b6-default-rtdb.firebaseio.com"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // Elementos
        const loginBox = document.getElementById('loginBox');
        const adminPanel = document.getElementById('adminPanel');
        const btnLoginGoogle = document.getElementById('btnLoginGoogle');
        const btnLogout = document.getElementById('btnLogout');
        const userName = document.getElementById('userName');
        const formProduct = document.getElementById('formProduct');
        const successMessage = document.getElementById('successMessage');
        const linkAfiliadoInput = document.getElementById('linkAfiliado');
        const urlImagemInput = document.getElementById('urlImagem');
        const imagemStatus = document.getElementById('imagemStatus');
        const previewImagem = document.getElementById('previewImagem');
        const imgPreview = document.getElementById('imgPreview');
        const listaProdutos = document.getElementById('listaProdutos');
        const formTitle = document.getElementById('formTitle');
        const btnSubmit = document.getElementById('btnSubmit');
        const btnCancelar = document.getElementById('btnCancelar');
        const produtoIdInput = document.getElementById('produtoId');

        // Fun√ß√£o para buscar imagem do produto
        async function buscarImagemProduto(url) {
            try {
                imagemStatus.textContent = 'üîç Buscando imagem...';
                imagemStatus.style.color = '#C9A961';

                // Usa o backend para todos os links (ele detecta automaticamente)
                await buscarImagemOpenGraph(url);
            } catch (error) {
                imagemStatus.textContent = '‚ÑπÔ∏è Cole a URL da imagem manualmente';
                imagemStatus.style.color = '#888';
                console.error('Erro:', error);
            }
        }

        // Buscar imagem via Open Graph ou Mercado Livre
        async function buscarImagemOpenGraph(url) {
            try {
                imagemStatus.textContent = 'üîç Extraindo imagem da p√°gina...';
                
                // Primeiro, tenta seguir redirecionamento se for link curto do ML
                let finalUrl = url;
                if (url.includes('/sec/')) {
                    try {
                        const redirectResponse = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`, {
                            redirect: 'follow'
                        });
                        finalUrl = redirectResponse.url || url;
                        console.log('URL ap√≥s redirecionamento:', finalUrl);
                    } catch (e) {
                        console.log('Erro ao seguir redirecionamento:', e);
                    }
                }
                
                // Detecta c√≥digo MLB na URL (mesmo ap√≥s redirecionamento)
                const mlbPatterns = [
                    /MLB[-\s]?(\d+)/i,
                    /\/p\/MLB(\d+)/i,
                    /\/MLB-?(\d+)-/i,
                    /mercadolivre\.com\.br\/.*?-MLB(\d+)/i,
                    /mercadolivre\.com\/.*?-MLB(\d+)/i
                ];
                
                let mlbCode = null;
                for (const pattern of mlbPatterns) {
                    const match = finalUrl.match(pattern);
                    if (match) {
                        mlbCode = match[1];
                        console.log('C√≥digo MLB encontrado:', mlbCode);
                        break;
                    }
                }
                
                // Se encontrou MLB, usa a API do Mercado Livre
                if (mlbCode) {
                    try {
                        const apiUrl = `https://api.mercadolibre.com/items/MLB${mlbCode}`;
                        console.log('Buscando na API do Mercado Livre:', apiUrl);
                        
                        const apiResponse = await fetch(apiUrl);
                        const data = await apiResponse.json();
                        
                        if (data.pictures && data.pictures[0]) {
                            const imageUrl = data.pictures[0].secure_url || data.pictures[0].url;
                            console.log('Imagem encontrada via API ML:', imageUrl);
                            
                            urlImagemInput.value = imageUrl;
                            imgPreview.src = imageUrl;
                            previewImagem.style.display = 'block';
                            imagemStatus.textContent = '‚úÖ Imagem encontrada!';
                            imagemStatus.style.color = '#4CAF50';
                            return;
                        }
                    } catch (apiError) {
                        console.log('Erro na API ML, tentando scraping:', apiError);
                    }
                }
                
                // Fallback: tenta Open Graph
                await buscarImagemOpenGraphFallback(finalUrl);
                
            } catch (error) {
                console.error('Erro ao buscar imagem:', error);
                imagemStatus.textContent = '‚ö†Ô∏è Cole a URL da imagem manualmente';
                imagemStatus.style.color = '#ff6b6b';
            }
        }

        // Fallback: extrai Open Graph tags
        async function buscarImagemOpenGraphFallback(url) {
            try {
                imagemStatus.textContent = 'üîç Tentando m√©todo alternativo...';
                
                // Usa proxy CORS para buscar o HTML da p√°gina
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const html = data.contents;
                
                // Busca meta tags de imagem (Open Graph, Twitter Card, etc.)
                const patterns = [
                    /<meta\s+property=["']og:image["']\s+content=["']([^"']+)["']/i,
                    /<meta\s+content=["']([^"']+)["']\s+property=["']og:image["']/i,
                    /<meta\s+name=["']twitter:image["']\s+content=["']([^"']+)["']/i,
                    /<meta\s+content=["']([^"']+)["']\s+name=["']twitter:image["']/i,
                    /<meta\s+itemprop=["']image["']\s+content=["']([^"']+)["']/i,
                    /<link\s+rel=["']image_src["']\s+href=["']([^"']+)["']/i
                ];
                
                let imagemUrl = null;
                for (const pattern of patterns) {
                    const match = html.match(pattern);
                    if (match && match[1]) {
                        imagemUrl = match[1];
                        console.log('Imagem encontrada via meta tag:', imagemUrl);
                        break;
                    }
                }
                
                if (imagemUrl) {
                    // Corrige URL relativa se necess√°rio
                    if (imagemUrl.startsWith('//')) {
                        imagemUrl = 'https:' + imagemUrl;
                    } else if (imagemUrl.startsWith('/')) {
                        const urlObj = new URL(url);
                        imagemUrl = urlObj.origin + imagemUrl;
                    }
                    
                    urlImagemInput.value = imagemUrl;
                    imgPreview.src = imagemUrl;
                    previewImagem.style.display = 'block';
                    imagemStatus.textContent = '‚úÖ Imagem encontrada!';
                    imagemStatus.style.color = '#4CAF50';
                } else {
                    imagemStatus.textContent = '‚ö†Ô∏è Cole a URL da imagem manualmente';
                    imagemStatus.style.color = '#ff6b6b';
                }
            } catch (error) {
                console.error('Erro ao buscar Open Graph:', error);
                imagemStatus.textContent = '‚ö†Ô∏è Cole a URL da imagem manualmente';
                imagemStatus.style.color = '#ff6b6b';
            }
        }

        // Buscar imagem do Mercado Livre
        async function buscarImagemMercadoLivre(url) {
            try {
                // Primeiro tenta extrair MLB do link direto
                let mlbMatch = url.match(/ML[A-Z]-?\d+/i);
                
                // Se n√£o encontrou, √© um link encurtado/afiliado
                if (!mlbMatch) {
                    console.log('Link de afiliado detectado, buscando produto...');
                    imagemStatus.textContent = 'üîç Processando link de afiliado...';
                    
                    try {
                        // Usa um proxy CORS para buscar o conte√∫do
                        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                        const response = await fetch(proxyUrl);
                        const data = await response.json();
                        
                        // Busca o c√≥digo MLB no conte√∫do HTML retornado
                        const html = data.contents;
                        
                        // Tenta v√°rios padr√µes
                        const patterns = [
                            /ML[A-Z]-?\d+/gi,
                            /"id":"(ML[A-Z]\d+)"/i,
                            /item_id":"(ML[A-Z]\d+)"/i,
                            /product_id":"(ML[A-Z]\d+)"/i,
                            /items\/(ML[A-Z]-?\d+)/i
                        ];
                        
                        for (const pattern of patterns) {
                            const matches = html.match(pattern);
                            if (matches) {
                                if (matches[1]) {
                                    mlbMatch = [matches[1]];
                                } else {
                                    mlbMatch = matches;
                                }
                                console.log('C√≥digo encontrado:', mlbMatch[0]);
                                break;
                            }
                        }
                        
                    } catch (error) {
                        console.error('Erro ao processar link de afiliado:', error);
                    }
                }
                
                if (!mlbMatch) {
                    imagemStatus.textContent = '‚ö†Ô∏è Cole o link direto do produto ou abra o link de afiliado para copiar a URL final';
                    imagemStatus.style.color = '#ff6b6b';
                    return;
                }

                const produtoId = mlbMatch[0].replace('-', '');
                console.log('ID do produto Mercado Livre:', produtoId);

                // Busca os dados do produto via API do Mercado Livre
                const apiUrl = `https://api.mercadolibre.com/items/${produtoId}`;
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error('Produto n√£o encontrado');
                }

                const data = await response.json();
                
                if (data.pictures && data.pictures.length > 0) {
                    // Pega a primeira imagem em alta qualidade
                    const imagemUrl = data.pictures[0].secure_url || data.pictures[0].url;
                    
                    urlImagemInput.value = imagemUrl;
                    imgPreview.src = imagemUrl;
                    previewImagem.style.display = 'block';
                    imagemStatus.textContent = '‚úÖ Imagem encontrada!';
                    imagemStatus.style.color = '#4CAF50';
                } else {
                    imagemStatus.textContent = '‚ö†Ô∏è Produto sem imagem dispon√≠vel.';
                    imagemStatus.style.color = '#ff6b6b';
                }
            } catch (error) {
                console.error('Erro ao buscar no Mercado Livre:', error);
                imagemStatus.textContent = '‚ö†Ô∏è Erro ao buscar produto. Tente o link direto do produto.';
                imagemStatus.style.color = '#ff6b6b';
            }
        }

        // Buscar imagem da Amazon
        function buscarImagemAmazon(url) {
            // Tenta v√°rios padr√µes de ASIN da Amazon
            const patterns = [
                /\/dp\/([A-Z0-9]{10})/,
                /\/product\/([A-Z0-9]{10})/,
                /\/gp\/product\/([A-Z0-9]{10})/,
                /\/d\/([A-Z0-9]{10})/,
                /ASIN[=:]([A-Z0-9]{10})/i,
                /\/([A-Z0-9]{10})(?:\/|\?|$)/
            ];

            let asin = null;
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    asin = match[1];
                    break;
                }
            }
            
            if (asin) {
                console.log('ASIN encontrado:', asin);
                
                // Tenta m√∫ltiplos formatos de URL de imagem da Amazon
                const imageFormats = [
                    `https://m.media-amazon.com/images/I/${asin}._AC_SL1500_.jpg`,
                    `https://images-na.ssl-images-amazon.com/images/I/${asin}._AC_UL1500_.jpg`,
                    `https://m.media-amazon.com/images/I/${asin}._AC_SX679_.jpg`,
                    `https://images-na.ssl-images-amazon.com/images/I/${asin}._SL1000_.jpg`
                ];
                
                tentarCarregarImagem(imageFormats, 0);
            } else {
                imagemStatus.textContent = '‚ö†Ô∏è N√£o encontrei o c√≥digo do produto. Cole a URL da imagem manualmente.';
                imagemStatus.style.color = '#ff6b6b';
            }
        }

        function tentarCarregarImagem(urls, index) {
            if (index >= urls.length) {
                imagemStatus.textContent = '‚ö†Ô∏è N√£o consegui carregar a imagem. Cole a URL manualmente.';
                imagemStatus.style.color = '#ff6b6b';
                return;
            }

            const img = new Image();
            img.onload = function() {
                urlImagemInput.value = urls[index];
                imgPreview.src = urls[index];
                previewImagem.style.display = 'block';
                imagemStatus.textContent = '‚úÖ Imagem encontrada!';
                imagemStatus.style.color = '#4CAF50';
            };
            img.onerror = function() {
                console.log('Tentativa falhou:', urls[index]);
                tentarCarregarImagem(urls, index + 1);
            };
            img.src = urls[index];
        }

        function tentarFormatoAlternativo(asin) {
            // Fun√ß√£o removida - agora usa tentarCarregarImagem
        }

        // Buscar imagem quando o link for colado
        linkAfiliadoInput.addEventListener('paste', (e) => {
            setTimeout(() => {
                const url = linkAfiliadoInput.value;
                if (url && url.startsWith('http')) {
                    buscarImagemProduto(url);
                }
            }, 100);
        });

        // Buscar imagem quando o link for digitado
        linkAfiliadoInput.addEventListener('input', (e) => {
            const url = e.target.value;
               // Busca automaticamente para qualquer URL v√°lida
            if (url.startsWith('http') && url.length > 20) {
                clearTimeout(linkAfiliadoInput.searchTimeout);
                linkAfiliadoInput.searchTimeout = setTimeout(() => {
                    buscarImagemProduto(url);
                }, 800);
            }
        });

        // Preview quando URL da imagem √© alterada manualmente
        urlImagemInput.addEventListener('input', (e) => {
            const url = e.target.value;
            if (url) {
                imgPreview.src = url;
                previewImagem.style.display = 'block';
                imagemStatus.textContent = '‚úÖ Imagem pronta!';
                imagemStatus.style.color = '#4CAF50';
            } else {
                previewImagem.style.display = 'none';
            }
        });

        // Preview quando URL da imagem √© alterada manualmente
        urlImagemInput.addEventListener('input', (e) => {
            const url = e.target.value;
            if (url) {
                imgPreview.src = url;
                previewImagem.style.display = 'block';
            } else {
                previewImagem.style.display = 'none';
            }
        });

        // Login com Google
        btnLoginGoogle.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert('Erro ao fazer login: ' + error.message);
            }
        });

        // Logout
        btnLogout.addEventListener('click', async () => {
            await signOut(auth);
        });

        // Verificar estado de autentica√ß√£o
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginBox.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                userName.textContent = user.displayName || user.email;
                
                // Carregar categorias quando autenticado
                carregarCategoriasAdmin();
            } else {
                loginBox.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }
        });

        // Adicionar ou editar produto
        formProduct.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Verifica se tem imagem
            if (!urlImagemInput.value) {
                alert('‚ö†Ô∏è Aguarde a busca autom√°tica da imagem ou cole a URL manualmente!');
                return;
            }

            const categoriaValue = document.getElementById('categoria').value;
            
            if (!categoriaValue) {
                alert('‚ö†Ô∏è Selecione uma categoria!');
                return;
            }

            const produto = {
                categoria: categoriaValue,
                nome: document.getElementById('nomeProduto').value,
                link: document.getElementById('linkAfiliado').value,
                imagem: document.getElementById('urlImagem').value,
                adicionadoPor: auth.currentUser.displayName || auth.currentUser.email,
                timestamp: Date.now()
            };

            try {
                const produtoId = produtoIdInput.value;
                
                if (produtoId) {
                    // Editar produto existente
                    await update(ref(database, `produtos/${produtoId}`), produto);
                    successMessage.textContent = 'Produto atualizado com sucesso!';
                    cancelarEdicao();
                } else {
                    // Adicionar novo produto
                    await push(ref(database, 'produtos'), produto);
                    successMessage.textContent = 'Produto adicionado com sucesso!';
                }
                
                // Mostrar mensagem de sucesso
                successMessage.classList.remove('hidden');
                setTimeout(() => {
                    successMessage.classList.add('hidden');
                }, 3000);

                // Limpar formul√°rio
                formProduct.reset();
                previewImagem.style.display = 'none';
                produtoIdInput.value = '';
                imagemStatus.textContent = 'Cole a URL da imagem do produto';
                imagemStatus.style.color = '#888';
            } catch (error) {
                alert('Erro ao salvar produto: ' + error.message);
            }
        });

        // Carregar lista de produtos
        function carregarListaProdutos() {
            const produtosRef = ref(database, 'produtos');
            
            onValue(produtosRef, (snapshot) => {
                const produtos = snapshot.val();
                
                if (!produtos) {
                    listaProdutos.innerHTML = '<p style="color: #888; text-align: center;">Nenhum produto cadastrado ainda.</p>';
                    return;
                }

                let html = '';
                Object.entries(produtos).forEach(([id, produto]) => {
                    const categoriaLabel = {
                        notebooks: 'Notebooks',
                        celulares: 'Celulares',
                        acessorios: 'Acess√≥rios',
                        games: 'Games'
                    }[produto.categoria] || produto.categoria;

                    const media = `<img src="${produto.imagem}" alt="${produto.nome}">`;

                    html += `
                        <div class="produto-item" data-id="${id}">
                            ${media}
                            <div class="produto-info">
                                <h4>${produto.nome} <span class="categoria-badge">${categoriaLabel}</span></h4>
                                <small>Adicionado por: ${produto.adicionadoPor}</small>
                            </div>
                            <div class="produto-acoes">
                                <button class="btn-editar" data-id="${id}" data-categoria="${produto.categoria}" data-nome="${produto.nome}" data-link="${produto.link}" data-imagem="${produto.imagem || ''}">‚úèÔ∏è Editar</button>
                                <button class="btn-excluir" data-id="${id}" data-nome="${produto.nome}">üóëÔ∏è Excluir</button>
                            </div>
                        </div>
                    `;
                });

                listaProdutos.innerHTML = html;

                // Adicionar event listeners aos bot√µes
                document.querySelectorAll('.btn-editar').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const produto = {
                            categoria: this.getAttribute('data-categoria'),
                            nome: this.getAttribute('data-nome'),
                            link: this.getAttribute('data-link'),
                            imagem: this.getAttribute('data-imagem')
                        };
                        editarProduto(id, produto);
                    });
                });

                document.querySelectorAll('.btn-excluir').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        const nome = this.getAttribute('data-nome');
                        excluirProduto(id, nome);
                    });
                });
            });
        }

        // Editar produto
        function editarProduto(id, produto) {
            // Preencher formul√°rio
            produtoIdInput.value = id;
            document.getElementById('categoria').value = produto.categoria;
            document.getElementById('nomeProduto').value = produto.nome;
            document.getElementById('linkAfiliado').value = produto.link;
            document.getElementById('urlImagem').value = produto.imagem || '';

            // Mostrar preview se tiver imagem
            if (produto.imagem) {
                imgPreview.src = produto.imagem;
                previewImagem.style.display = 'block';
            }

            // Alterar UI para modo edi√ß√£o
            formTitle.textContent = 'Editar Produto';
            btnSubmit.textContent = 'Salvar Altera√ß√µes';
            btnCancelar.style.display = 'block';

            // Scroll para o formul√°rio
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Excluir produto
        async function excluirProduto(id, nome) {
            if (confirm(`Tem certeza que deseja excluir "${nome}"?`)) {
                try {
                    await remove(ref(database, `produtos/${id}`));
                    successMessage.textContent = 'Produto exclu√≠do com sucesso!';
                    successMessage.classList.remove('hidden');
                    setTimeout(() => {
                        successMessage.classList.add('hidden');
                    }, 3000);
                } catch (error) {
                    alert('Erro ao excluir produto: ' + error.message);
                }
            }
        }

        // Cancelar edi√ß√£o
        function cancelarEdicao() {
            produtoIdInput.value = '';
            formTitle.textContent = 'Adicionar Novo Produto';
            btnSubmit.textContent = 'Adicionar Produto';
            btnCancelar.style.display = 'none';
            formProduct.reset();
            previewImagem.style.display = 'none';
            imagemStatus.textContent = 'Cole a URL da imagem do produto';
            imagemStatus.style.color = '#888';
        }

        btnCancelar.addEventListener('click', cancelarEdicao);

        // Carregar produtos quando usu√°rio logar
        onAuthStateChanged(auth, (user) => {
            if (user) {
                carregarListaProdutos();
                carregarCategoriasAdmin();
            }
        });

        // ============= GERENCIAMENTO DE CATEGORIAS =============

        const btnAdicionarCategoria = document.getElementById('btnAdicionarCategoria');
        const novaCategoriaNome = document.getElementById('novaCategoriaNome');
        const novaCategoriaOrdem = document.getElementById('novaCategoriaOrdem');
        const listaCategoriasAdmin = document.getElementById('listaCategoriasAdmin');

        // Adicionar categoria
        btnAdicionarCategoria.addEventListener('click', async () => {
            const nome = novaCategoriaNome.value.trim();
            const ordem = parseInt(novaCategoriaOrdem.value) || 1;
            
            if (!nome) {
                alert('‚ö†Ô∏è Digite o nome da categoria!');
                return;
            }
            
            const categoriaId = nome.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '');
            
            try {
                await set(ref(database, `categorias/${categoriaId}`), {
                    nome: nome,
                    ordem: ordem
                });
                
                successMessage.textContent = 'Categoria adicionada com sucesso!';
                successMessage.classList.remove('hidden');
                setTimeout(() => successMessage.classList.add('hidden'), 3000);
                
                novaCategoriaNome.value = '';
                novaCategoriaOrdem.value = parseInt(novaCategoriaOrdem.value) + 1;
            } catch (error) {
                alert('Erro ao adicionar categoria: ' + error.message);
            }
        });

        // Carregar categorias no admin
        function carregarCategoriasAdmin() {
            const categoriasRef = ref(database, 'categorias');
            
            onValue(categoriasRef, (snapshot) => {
                const categorias = snapshot.val();
                
                // Atualizar select do formul√°rio de produtos
                atualizarSelectCategorias(categorias);
                
                // Atualizar lista de gerenciamento
                if (!categorias) {
                    listaCategoriasAdmin.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">Nenhuma categoria cadastrada.</p>';
                    return;
                }
                
                const categoriasOrdenadas = Object.entries(categorias).sort((a, b) => {
                    return (a[1].ordem || 0) - (b[1].ordem || 0);
                });
                
                let html = '';
                categoriasOrdenadas.forEach(([id, cat]) => {
                    html += `
                        <div style="background: rgba(15, 15, 15, 0.6); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(201, 169, 97, 0.2);">
                            <div>
                                <strong style="color: #E6D5A8; font-size: 1.1rem;">${cat.nome}</strong>
                                <small style="color: #888; display: block; margin-top: 3px;">ID: ${id} | Ordem: ${cat.ordem}</small>
                            </div>
                            <button onclick="removerCategoria('${id}', '${cat.nome}')" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                üóëÔ∏è Remover
                            </button>
                        </div>
                    `;
                });
                
                listaCategoriasAdmin.innerHTML = html;
            });
        }

        // Atualizar select de categorias no formul√°rio
        function atualizarSelectCategorias(categorias) {
            const selectCategoria = document.getElementById('categoria');
            const valorAtual = selectCategoria.value;
            
            selectCategoria.innerHTML = '<option value="">Selecione...</option>';
            
            if (categorias) {
                const categoriasOrdenadas = Object.entries(categorias).sort((a, b) => {
                    return (a[1].ordem || 0) - (b[1].ordem || 0);
                });
                
                categoriasOrdenadas.forEach(([id, cat]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = cat.nome;
                    selectCategoria.appendChild(option);
                });
            }
            
            // Restaurar valor selecionado
            if (valorAtual) {
                selectCategoria.value = valorAtual;
            }
        }

        // Remover categoria
        window.removerCategoria = async (categoriaId, nome) => {
            if (!confirm(`‚ö†Ô∏è Tem certeza que deseja remover "${nome}"?\n\nIsso tamb√©m remover√° TODOS os produtos desta categoria!`)) {
                return;
            }
            
            try {
                // Buscar todos os produtos desta categoria
                const produtosRef = ref(database, 'produtos');
                const snapshot = await new Promise((resolve) => {
                    onValue(produtosRef, resolve, { onlyOnce: true });
                });
                
                const produtosParaRemover = [];
                if (snapshot.val()) {
                    Object.entries(snapshot.val()).forEach(([id, produto]) => {
                        if (produto.categoria === categoriaId) {
                            produtosParaRemover.push(id);
                        }
                    });
                }
                
                // Remover produtos da categoria
                for (const produtoId of produtosParaRemover) {
                    await remove(ref(database, `produtos/${produtoId}`));
                }
                
                // Remover categoria
                await remove(ref(database, `categorias/${categoriaId}`));
                
                successMessage.textContent = `Categoria removida com sucesso! (${produtosParaRemover.length} produtos deletados)`;
                successMessage.classList.remove('hidden');
                setTimeout(() => successMessage.classList.add('hidden'), 3000);
                
                carregarCategoriasAdmin();
            } catch (error) {
                alert('Erro ao remover categoria: ' + error.message);
            }
        };
    </script>
</body>
</html>
